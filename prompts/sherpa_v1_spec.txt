Project Specification: SHERPA V1 - Autonomous Coding Orchestrator
===================================================================

## Overview

SHERPA is an orchestration platform that enhances autonomous coding agents with organizational knowledge. It operates in two modes:
1. **Generate Mode**: Create instruction files for interactive agents (Cursor, Claude, Copilot)
2. **Run Mode**: Execute autonomous coding harness with knowledge injection

## Technology Stack

### Backend (Python - matching autonomous-coding pattern)
- Framework: FastAPI (async/await)
- Database: SQLite with aiosqlite
- Knowledge: AWS S3 + Bedrock Knowledge Base (vector search)
- Queue: asyncio for concurrent operations
- CLI: Click + Rich (beautiful terminal output)

### Frontend (React + Vite Dashboard - MANDATORY, NO SHORTCUTS!)

**CRITICAL: Must be actual React application, NOT HTML test files!**

**Required Setup:**
- **Framework:** React 18.3.1 with Vite 5.0.0 (NOT plain HTML!)
- **Build Tool:** Vite dev server (npm run dev) on port 3000
- **Styling:** Tailwind CSS 3.4.0
- **State:** React Context API + hooks
- **Routing:** React Router 6.20.0 (client-side routing)
- **Real-time:** EventSource (SSE) for live updates
- **Charts:** Recharts 2.10.0 for progress visualization
- **HTTP:** Axios 1.7.0 for API calls
- **Icons:** Lucide React for UI icons

**Package.json MUST include:**
```json
{
  "name": "sherpa-frontend",
  "scripts": {
    "dev": "vite --port 3000",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.20.0",
    "axios": "^1.7.0",
    "recharts": "^2.10.0",
    "lucide-react": "^0.300.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.0",
    "vite": "^5.0.0",
    "tailwindcss": "^3.4.0",
    "autoprefixer": "^10.4.0",
    "postcss": "^8.4.0"
  }
}
```

**File Structure MUST be:**
```
sherpa/frontend/
├── index.html (Vite entry point)
├── package.json
├── vite.config.js
├── tailwind.config.js
├── postcss.config.js
└── src/
    ├── main.jsx (React entry point, ReactDOM.render)
    ├── App.jsx (main app component with routing)
    ├── pages/
    │   ├── HomePage.jsx
    │   ├── SessionsPage.jsx
    │   ├── SessionDetailPage.jsx
    │   ├── KnowledgePage.jsx
    │   └── SourcesPage.jsx
    ├── components/
    │   ├── SessionMonitor.jsx (SSE live updates)
    │   ├── ProgressChart.jsx (Recharts)
    │   ├── SnippetBrowser.jsx
    │   └── AzureDevOpsConnector.jsx
    ├── lib/
    │   └── api.js (Axios instance)
    └── styles/
        └── index.css (Tailwind imports)
```

**TESTING REQUIREMENT:**
- Frontend MUST run with `npm run dev` on port 3000
- MUST be accessible at http://localhost:3000
- MUST use Playwright for testing (NOT manual HTML test files!)
- NO shortcuts: Build proper React components, not static HTML

### Integrations
- Azure DevOps: azure-devops Python SDK (Work Items API)
- AWS Bedrock: boto3 for Knowledge Base queries
- Git: GitPython for commit tracking
- File watching: watchdog for repo scanning

## Architecture

### Knowledge Layer (S3 + Bedrock KB)

**Storage Hierarchy:**
```
1. Built-in (lowest priority)   → Shipped with package
2. Org (via S3 + Bedrock)       → s3://bayer-sherpa-snippets/
3. Project (in repo)            → ./sherpa/snippets/
4. Local (gitignored)           → ./sherpa/snippets.local/
```

**Resolution:**
- Query Bedrock KB for org/built-in snippets
- Scan local files for project/local overrides
- Merge with priority (local > project > org > built-in)

### Two Modes

**Mode 1: Generate (Instruction Files)**
```bash
sherpa generate
# Output:
# .cursor/rules/security.mdc
# .cursor/rules/api-patterns.mdc
# CLAUDE.md
# .github/copilot-instructions.md
```

**Mode 2: Run (Autonomous Harness)**
```bash
sherpa run --spec app_spec.txt
sherpa run --source azure-devops --project PHCom
# Executes Claude Code SDK autonomous loop with knowledge injection
```

## Core Features (V1 MVP)

### 1. CLI Commands

**Setup:**
- `sherpa init` - Configure Bedrock KB connection, set up project
- `sherpa config set <key> <value>` - Configure settings

**Generate Mode:**
- `sherpa generate` - Generate all instruction files
- `sherpa generate --agent cursor` - Generate only for Cursor
- `sherpa scan` - Analyze repo and show detected patterns

**Run Mode:**
- `sherpa run --spec <file>` - Run autonomous harness with file spec
- `sherpa run --source azure-devops` - Run with Azure DevOps work items

**Knowledge:**
- `sherpa query <text>` - Query Bedrock KB for snippets
- `sherpa snippets list` - List all available snippets

**Monitoring:**
- `sherpa status` - Show active sessions
- `sherpa logs <session-id>` - View session logs

### 2. Knowledge Layer

**Bedrock KB Integration:**
- Connect to AWS Bedrock Knowledge Base
- Query for relevant snippets using semantic search
- Cache results locally for offline use

**Repo Scanner (Brownfield):**
- Scan README.md, docs/, existing code
- Extract tech stack from package.json, requirements.txt
- Detect code patterns (naming, structure, imports)
- Generate repo-specific context

**Snippet Resolution:**
- Query Bedrock KB with context
- Load project snippets from ./sherpa/snippets/
- Load local overrides from ./sherpa/snippets.local/
- Merge with priority hierarchy

### 3. Azure DevOps Adapter

**Spec Source:**
- Authenticate with Personal Access Token
- Query work items by project/area path
- Convert work items to Sherpa specs
- Support WIQL queries for custom filters

**Progress Tracker:**
- Update work item state (New → Active → Resolved)
- Add comments with implementation notes
- Link git commits to work items
- Update custom fields with progress percentage

**Configuration:**
```python
# sherpa.toml
[azure_devops]
organization = "https://dev.azure.com/bayer"
project = "PHCom"
pat_env = "AZURE_DEVOPS_PAT"  # Environment variable name
area_path = "PHCom/IDP"        # Optional filter
```

### 4. Autonomous Harness (Run Mode)

**Based on autonomous-coding pattern:**
- Two-agent pattern (initializer + coding agents)
- Session management with fresh context windows
- Auto-continue loop (3 second delay)
- Progress tracking via feature_list.json
- Git integration

**Enhanced with Knowledge:**
- Inject CODING_STANDARDS.md into prompts
- Add relevant snippets from Bedrock KB
- Include repo scan results
- Provide project-specific context

### 5. File Generators (Generate Mode)

**Cursor Rules (.cursor/rules/*.mdc):**
```markdown
---
description: Security best practices
globs: ["**/*.py", "**/*.js"]
---

# Security Guidelines
[Snippet content from Bedrock KB]
```

**Claude Instructions (CLAUDE.md):**
```markdown
# Coding Standards for This Project

## Architecture
[From repo scan]

## Patterns
[From Bedrock KB snippets]

## Testing
[From project snippets]
```

**GitHub Copilot (.github/copilot-instructions.md):**
```markdown
# Instructions for GitHub Copilot
[Converted from snippets]
```

### 6. Frontend Dashboard

**Pages:**
1. **Home** - Active sessions, quick actions
2. **Sessions** - List all sessions with progress bars
3. **Knowledge** - Browse snippets, query Bedrock KB
4. **Sources** - Configure Azure DevOps, file sources
5. **Settings** - API keys, preferences

**Components:**
- Session monitor (real-time progress via SSE)
- Snippet browser
- Azure DevOps connector
- Progress charts

## Database Schema (SQLite)

```sql
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  spec_source TEXT NOT NULL,
  spec_id TEXT,
  agent_type TEXT NOT NULL,
  mode TEXT NOT NULL,
  project_dir TEXT NOT NULL,
  status TEXT NOT NULL,
  started_at DATETIME,
  completed_at DATETIME,
  error TEXT,
  metadata JSON
);

CREATE TABLE progress (
  id TEXT PRIMARY KEY,
  session_id TEXT REFERENCES sessions(id),
  features_total INTEGER,
  features_passing INTEGER,
  last_update DATETIME,
  git_commits JSON,
  logs TEXT
);

CREATE TABLE snippets_cache (
  id TEXT PRIMARY KEY,
  source TEXT NOT NULL,
  category TEXT,
  title TEXT,
  content TEXT,
  metadata JSON,
  cached_at DATETIME
);

CREATE TABLE sources (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  name TEXT NOT NULL,
  config JSON NOT NULL,
  enabled BOOLEAN DEFAULT true,
  last_sync DATETIME
);
```

## API Endpoints

### Sessions
- `POST /api/sessions/run` - Start autonomous harness
- `POST /api/sessions/generate` - Generate instruction files
- `GET /api/sessions` - List all sessions
- `GET /api/sessions/:id` - Get session details
- `GET /api/sessions/:id/progress` - Real-time progress (SSE)
- `DELETE /api/sessions/:id` - Stop session

### Knowledge
- `POST /api/knowledge/query` - Query Bedrock KB
- `GET /api/knowledge/snippets` - List all snippets
- `POST /api/knowledge/scan` - Scan current repo
- `POST /api/knowledge/sync` - Refresh from S3/Bedrock

### Sources
- `GET /api/sources` - List configured sources
- `POST /api/sources` - Add source (Azure DevOps, file, etc.)
- `PUT /api/sources/:id` - Update source
- `POST /api/sources/:id/sync` - Sync source

### Generation
- `POST /api/generate/cursor` - Generate .cursor/rules/
- `POST /api/generate/claude` - Generate CLAUDE.md
- `POST /api/generate/all` - Generate all instruction files

## Implementation Priority

### Phase 1: Core (Build This First!)
1. CLI skeleton (init, run, generate, query)
2. S3 + Bedrock KB integration
3. File-based spec source
4. Autonomous harness (reuse autonomous-coding code!)
5. Basic instruction file generation (CLAUDE.md)
6. SQLite database
7. Simple FastAPI backend
8. Minimal React frontend (dashboard + session monitor)

### Phase 2: Enterprise Integration
9. Azure DevOps source adapter
10. Azure DevOps progress tracker
11. Repo scanner (brownfield)
12. Full instruction file generators (Cursor, Copilot, Gemini)
13. Knowledge hierarchy resolution
14. Progress charts and visualizations

### Phase 3: Polish
15. Rich CLI output with progress bars
16. Error handling and recovery
17. Configuration file (sherpa.toml)
18. Session resume/pause
19. Documentation
20. Tests

## File Structure

```
sherpa/
├── cli.py                          # Click-based CLI
├── api/
│   ├── main.py                     # FastAPI application
│   ├── routes/
│   │   ├── sessions.py
│   │   ├── knowledge.py
│   │   ├── sources.py
│   │   └── generation.py
│   └── models.py                   # Pydantic models
├── knowledge/
│   ├── bedrock_client.py           # AWS Bedrock KB client
│   ├── resolver.py                 # Hierarchy resolution
│   ├── scanner.py                  # Repo scanner
│   └── snippets/                   # Built-in snippets
│       ├── security/
│       ├── python/
│       └── testing/
├── adapters/
│   ├── base.py                     # ABC for adapters
│   ├── sources/
│   │   ├── file.py
│   │   └── azure_devops.py
│   ├── agents/
│   │   └── claude_code.py
│   └── trackers/
│       ├── json.py
│       └── azure_devops.py
├── harness/
│   ├── agent.py                    # From autonomous-coding
│   ├── client.py                   # From autonomous-coding
│   ├── security.py                 # From autonomous-coding
│   ├── progress.py                 # From autonomous-coding
│   └── prompts/
│       ├── initializer_prompt.md   # Enhanced with knowledge
│       └── coding_prompt.md        # Enhanced with knowledge
├── generators/
│   ├── cursor.py                   # Generate .cursor/rules/
│   ├── claude.py                   # Generate CLAUDE.md
│   ├── copilot.py                  # Generate copilot-instructions.md
│   └── base.py                     # ABC for generators
├── frontend/
│   ├── src/
│   │   ├── App.jsx
│   │   ├── components/
│   │   │   ├── Dashboard.jsx
│   │   │   ├── SessionMonitor.jsx
│   │   │   ├── KnowledgeBrowser.jsx
│   │   │   └── SourcesConfig.jsx
│   │   └── pages/
│   ├── index.html
│   └── vite.config.js
├── database.py                     # SQLite setup
├── requirements.txt
├── package.json
└── README.md
```

## Success Criteria

### Functional
- ✅ Query Bedrock KB for org snippets
- ✅ Generate CLAUDE.md with injected knowledge
- ✅ Run autonomous harness with enhanced prompts
- ✅ Pull specs from Azure DevOps work items
- ✅ Update Azure DevOps with progress
- ✅ Scan existing repos for patterns
- ✅ Frontend dashboard shows active sessions

### UX
- ✅ Beautiful CLI output with Rich library
- ✅ Real-time progress in web dashboard
- ✅ Simple configuration (sherpa.toml)
- ✅ Clear error messages
- ✅ Fast snippet queries

### Technical
- ✅ Reuses autonomous-coding harness code
- ✅ Bedrock KB integration works
- ✅ Azure DevOps sync bidirectional
- ✅ Knowledge hierarchy resolves correctly
- ✅ Concurrent session support

## Built-in Snippets (Ship with Package)

1. `security/authentication.md` - Auth patterns
2. `python/error-handling.md` - Python error handling
3. `python/async-patterns.md` - Async/await best practices
4. `react/hooks.md` - React hooks patterns
5. `testing/unit-tests.md` - Testing guidelines
6. `api/rest-design.md` - REST API conventions
7. `git/commit-messages.md` - Commit message format

## Configuration Example

```toml
# sherpa.toml

[bedrock]
region = "us-east-1"
knowledge_base_id = "KB123456"  # Created in AWS Console
aws_profile = "bayer"           # Or use env vars

[azure_devops]
organization = "https://dev.azure.com/bayer"
project = "PHCom"
area_path = "PHCom/IDP"
# PAT from env: AZURE_DEVOPS_PAT

[generation]
agents = ["cursor", "claude"]
output_dir = "./"

[harness]
agent = "claude-code"
max_iterations = null  # Unlimited
auto_continue_delay = 3
```

## Usage Examples

```bash
# Setup
sherpa init
# Prompts for: Bedrock KB ID, Azure DevOps org, etc.

# Generate instruction files
sherpa generate
# Creates: .cursor/rules/*.mdc, CLAUDE.md

# Run autonomous harness
sherpa run --spec app_spec.txt
sherpa run --source azure-devops --work-item 12345

# Query knowledge base
sherpa query "authentication best practices"

# Scan existing repo
sherpa scan
# Output: Detected patterns, tech stack, suggestions

# Monitor session
sherpa status SESSION-123
sherpa logs SESSION-123

# Web dashboard
sherpa serve
# Opens http://localhost:8000
```

## Development Approach

**Start by copying autonomous-coding harness:**
- Reuse: agent.py, client.py, security.py, progress.py
- Enhance prompts with Bedrock KB queries
- Add CLI layer on top
- Add API layer for frontend
- Build generators for instruction files

**Priority order:**
1. Bedrock KB integration (core differentiator)
2. CLI with generate + run modes
3. Azure DevOps adapter (enterprise use case)
4. File-based specs (fallback)
5. Repo scanner (brownfield support)
6. Frontend dashboard (stakeholder visibility)

## Key Files Generated

### For Cursor (.cursor/rules/security.mdc)
```markdown
---
description: Security best practices from Bayer standards
globs: ["**/*.py", "**/*.js"]
alwaysRun: true
---

# Security Guidelines

## Authentication
[Content from Bedrock KB: bayer/security/authentication.md]

## Input Validation
[Content from Bedrock KB: python/input-validation.md]
```

### For Claude (CLAUDE.md)
```markdown
# Coding Standards for PHCom Project

## Architecture
[From repo scan]

## Patterns Detected
[From scanner: FastAPI, React, Tailwind]

## Org Standards
[From Bedrock KB queries]

## Testing Requirements
[From project snippets]
```

## Success Metrics

**Must Have:**
- ✅ Bedrock KB returns relevant snippets
- ✅ Generated CLAUDE.md improves code quality
- ✅ Azure DevOps sync works bidirectionally
- ✅ Autonomous harness completes sessions
- ✅ Frontend shows real-time progress

**Nice to Have:**
- Repo scanner detects 90%+ of tech stack
- Generate mode works for all major agents
- Multiple concurrent sessions supported
- Sub-second Bedrock KB queries

## What Makes This Lean

**Included in V1:**
- S3 + Bedrock KB (core value prop)
- Two modes (generate + run)
- Azure DevOps (your use case)
- Basic frontend (visibility)
- Repo scanner (brownfield)

**Deferred to V1.1:**
- Linear, Jira, GitHub, Notion adapters
- Multiple agent support in run mode
- Marketplace for snippets
- Advanced workflow automation
- Team collaboration features

## Port Configuration

- Backend API: 8000
- Frontend: 3000 (Vite dev server)

## Expected Build Time

Using autonomous-coding harness:
- Session 1 (init): 15-30 minutes → Generate ~200 test cases
- Sessions 2-20: 5-15 min each → ~10 hours total
- **Total: ~12-15 hours for working V1**

## Dogfooding Plan

**Build Sherpa WITH the harness it will enhance:**
1. Use autonomous-coding (Claude Code SDK)
2. Feed it this spec
3. It builds Sherpa
4. Sherpa includes the harness code (agents/claude_code/)
5. Use Sherpa to build next projects (Togglr, etc.)

This validates the entire concept!



