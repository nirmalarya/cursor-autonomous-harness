Project Specification: SHERPA - Autonomous Coding Orchestrator
================================================================

## Overview

SHERPA is a meta-orchestration system that coordinates autonomous coding agents across multiple specification sources and progress tracking systems. It acts as an intelligent middleware that:
1. Pulls requirements from various sources (Jira, Linear, GitHub, Notion, files)
2. Enhances them with coding standards and context
3. Delegates to appropriate coding agents (Cursor, Claude Code, GitHub Copilot)
4. Tracks progress back to multiple systems

## Technology Stack

### Backend (Python - matching autonomous-coding pattern!)
- Runtime: Python 3.10+
- Framework: FastAPI (async/await support)
- Database: SQLite with sqlite3
- Queue: asyncio + aiosqlite for async operations
- API: RESTful + Server-Sent Events (SSE) for real-time updates
- Validation: Pydantic models

### Frontend
- Framework: React with Vite
- Styling: Tailwind CSS (via CDN)
- State: React Context + hooks
- UI: shadcn/ui components
- Real-time: EventSource (SSE client)

### Integrations
- Linear: MCP client (Python)
- Jira: jira-python library (REST API v3)
- GitHub: PyGithub (GraphQL via gql library)
- Notion: notion-client (Official Python SDK)
- Cursor Agent: Subprocess execution (cursor_autonomous_agent.py) ✅
- Claude Code: claude-code-sdk (Python SDK) ✅
- File System: watchdog for file monitoring

## Architecture Layers

### 1. Spec Sources (Input Adapters)

Each source adapter implements a common interface (Python pattern matching autonomous-coding):

```python
from abc import ABC, abstractmethod
from typing import List, Dict, Any
from pydantic import BaseModel
from enum import Enum

class SourceType(str, Enum):
    FILE = "file"
    LINEAR = "linear"
    JIRA = "jira"
    GITHUB = "github"
    NOTION = "notion"

class Priority(str, Enum):
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

class Spec(BaseModel):
    id: str
    title: str
    description: str
    requirements: List[str]
    acceptance_criteria: List[str]
    priority: Priority
    source: str
    source_url: str
    metadata: Dict[str, Any]

class SpecSource(ABC):
    """Base class for all spec source adapters."""
    
    def __init__(self, id: str, name: str, config: Dict[str, Any]):
        self.id = id
        self.name = name
        self.config = config
        self.type: SourceType
    
    @abstractmethod
    async def fetch_specs(self) -> List[Spec]:
        """Fetch specs from the source."""
        pass
    
    @abstractmethod
    async def sync(self) -> Dict[str, Any]:
        """Sync with the source."""
        pass
    
    @abstractmethod
    async def validate(self) -> bool:
        """Validate connection to source."""
        pass
```

**Adapters to implement:**

1. **File/Folder Adapter**
   - Watches directories for markdown files
   - Parses specs from markdown format
   - Supports templates (app_spec.txt format)

2. **Linear Adapter (MCP)**
   - Connects via MCP server
   - Fetches issues/projects
   - Syncs bidirectionally

3. **Jira Adapter (API)**
   - REST API v3 integration
   - JQL query support
   - Custom field mapping

4. **GitHub Adapter**
   - GraphQL API for issues
   - Project v2 support
   - Label filtering

5. **Notion Adapter**
   - Database integration
   - Page parsing
   - Property mapping

### 2. Knowledge Layer

**Purpose:** Enhance specs with project-specific context

Components:

1. **Code Snippet Analyzer**
   ```python
   from pathlib import Path
   from typing import List
   
   class SnippetAnalyzer:
       """Analyzes codebase to extract patterns and standards."""
       
       async def analyze_codebase(self, path: Path) -> List[Snippet]:
           """Analyze codebase and extract code snippets."""
           pass
       
       def extract_patterns(self, snippets: List[Snippet]) -> List[Pattern]:
           """Extract patterns from snippets."""
           pass
       
       def generate_standards(self, patterns: List[Pattern]) -> CodingStandards:
           """Generate coding standards from patterns."""
           pass
   ```

2. **Coding Standards Generator**
   - Analyzes existing codebase
   - Extracts patterns (naming, structure, imports)
   - Generates CODING_STANDARDS.md
   - Updates based on new code

3. **Prompt Enhancer**
   - Takes base spec
   - Adds coding standards
   - Includes relevant snippets
   - Creates context-rich prompt

### 3. Progress Tracking (Output Adapters)

Each tracker implements (Python pattern):

```python
from abc import ABC, abstractmethod
from datetime import datetime
from enum import Enum

class TaskStatus(str, Enum):
    PENDING = "pending"
    IN_PROGRESS = "in_progress"
    BLOCKED = "blocked"
    COMPLETED = "completed"

class TrackerType(str, Enum):
    JSON = "json"
    LINEAR = "linear"
    JIRA = "jira"
    GITHUB = "github"
    NOTION = "notion"

class Progress(BaseModel):
    task_id: str
    status: TaskStatus
    percent_complete: int
    features_completed: int
    features_total: int
    last_update: datetime
    agent_logs: List[str]
    commits: List[Dict[str, Any]]

class ProgressTracker(ABC):
    """Base class for all progress trackers."""
    
    def __init__(self, id: str, name: str, config: Dict[str, Any]):
        self.id = id
        self.name = name
        self.config = config
        self.type: TrackerType
    
    @abstractmethod
    async def update_progress(self, task_id: str, progress: Progress) -> None:
        """Update progress for a task."""
        pass
    
    @abstractmethod
    async def create_task(self, spec: Spec) -> Dict[str, Any]:
        """Create a new task from spec."""
        pass
    
    @abstractmethod
    async def complete_task(self, task_id: str) -> None:
        """Mark task as complete."""
        pass
    
    @abstractmethod
    async def sync(self) -> None:
        """Sync with tracker system."""
        pass
```

**Trackers to implement:**

1. **Local JSON Tracker**
   - feature_list.json format
   - Git-friendly
   - Fast local access

2. **Linear Tracker**
   - Update issue status
   - Add comments with progress
   - Link commits

3. **Jira Tracker**
   - Transition tickets
   - Update custom fields
   - Add work logs

4. **GitHub Tracker**
   - Update issue status
   - Add progress comments
   - Link PRs/commits

5. **Notion Tracker**
   - Update database properties
   - Add progress blocks
   - Link to code

### 4. Agent Adapters

Each agent implements (Python pattern matching autonomous-coding):

```python
from abc import ABC, abstractmethod
from typing import AsyncIterator
from enum import Enum

class AgentType(str, Enum):
    CURSOR = "cursor"
    CLAUDE_CODE = "claude-code"
    GITHUB_COPILOT = "github-copilot"

class CodingAgent(ABC):
    """Base class for all coding agents (like autonomous-coding pattern)."""
    
    def __init__(self, id: str):
        self.id = id
        self.type: AgentType
    
    @abstractmethod
    async def start_session(self, spec: Dict[str, Any]) -> Dict[str, Any]:
        """Start a new coding session."""
        pass
    
    @abstractmethod
    async def monitor_progress(self, session_id: str) -> AsyncIterator[Progress]:
        """Monitor session progress (async generator)."""
        pass
    
    @abstractmethod
    async def stop_session(self, session_id: str) -> None:
        """Stop a running session."""
        pass
    
    @abstractmethod
    async def get_status(self, session_id: str) -> Dict[str, Any]:
        """Get current session status."""
        pass
```

**Agents to implement:**

1. **Cursor Agent** (✅ Already built!)
   - Uses cursor_autonomous_agent.py
   - Subprocess execution
   - Progress monitoring via file system

2. **Claude Code Agent**
   - Uses Claude Code SDK
   - OAuth authentication
   - Real-time streaming

3. **GitHub Copilot Agent** (Future)
   - Copilot Workspace integration
   - API when available

## Database Schema

```sql
-- Sources (input adapters)
CREATE TABLE sources (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  name TEXT NOT NULL,
  config JSON NOT NULL,
  enabled BOOLEAN DEFAULT true,
  last_sync DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Specs (pulled from sources)
CREATE TABLE specs (
  id TEXT PRIMARY KEY,
  source_id TEXT REFERENCES sources(id),
  title TEXT NOT NULL,
  description TEXT,
  requirements JSON,
  acceptance_criteria JSON,
  priority TEXT,
  source_url TEXT,
  metadata JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Coding standards
CREATE TABLE coding_standards (
  id TEXT PRIMARY KEY,
  project_id TEXT,
  content TEXT NOT NULL,
  patterns JSON,
  snippets JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Agent sessions
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  spec_id TEXT REFERENCES specs(id),
  agent_type TEXT NOT NULL,
  status TEXT NOT NULL,
  project_dir TEXT NOT NULL,
  started_at DATETIME,
  completed_at DATETIME,
  error TEXT,
  metadata JSON
);

-- Progress tracking
CREATE TABLE progress (
  id TEXT PRIMARY KEY,
  session_id TEXT REFERENCES sessions(id),
  status TEXT NOT NULL,
  percent_complete INTEGER,
  features_completed INTEGER,
  features_total INTEGER,
  logs JSON,
  commits JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Progress trackers (output adapters)
CREATE TABLE trackers (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  name TEXT NOT NULL,
  config JSON NOT NULL,
  enabled BOOLEAN DEFAULT true,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Tracker sync log
CREATE TABLE tracker_syncs (
  id TEXT PRIMARY KEY,
  tracker_id TEXT REFERENCES trackers(id),
  session_id TEXT REFERENCES sessions(id),
  status TEXT NOT NULL,
  synced_at DATETIME,
  error TEXT
);
```

## API Endpoints

### Sources
- `GET /api/sources` - List all spec sources
- `POST /api/sources` - Add new source
- `PUT /api/sources/:id` - Update source
- `DELETE /api/sources/:id` - Remove source
- `POST /api/sources/:id/sync` - Trigger sync
- `GET /api/sources/:id/specs` - Get specs from source

### Specs
- `GET /api/specs` - List all specs
- `GET /api/specs/:id` - Get spec details
- `POST /api/specs` - Create spec manually
- `PUT /api/specs/:id` - Update spec
- `DELETE /api/specs/:id` - Delete spec

### Knowledge
- `POST /api/knowledge/analyze` - Analyze codebase
- `GET /api/knowledge/standards/:projectId` - Get coding standards
- `POST /api/knowledge/enhance` - Enhance spec with standards
- `PUT /api/knowledge/standards/:id` - Update standards

### Sessions
- `POST /api/sessions` - Start new agent session
- `GET /api/sessions` - List sessions
- `GET /api/sessions/:id` - Get session details
- `DELETE /api/sessions/:id` - Stop session
- `GET /api/sessions/:id/progress` - Get real-time progress (SSE)
- `GET /api/sessions/:id/logs` - Get agent logs

### Trackers
- `GET /api/trackers` - List progress trackers
- `POST /api/trackers` - Add tracker
- `PUT /api/trackers/:id` - Update tracker
- `DELETE /api/trackers/:id` - Remove tracker
- `POST /api/trackers/:id/sync` - Manual sync

### Agents
- `GET /api/agents` - List available agents
- `GET /api/agents/:type/status` - Check agent availability

## UI Components

### 1. Dashboard
- Active sessions overview
- Progress summary
- Recent activity
- Quick actions

### 2. Sources Management
- List configured sources
- Add/edit/remove sources
- Sync status
- Connection testing

### 3. Specs View
- List all specs from all sources
- Filter by source/priority/status
- Search and sort
- Spec details modal

### 4. Knowledge Base
- View coding standards
- Codebase snippets
- Pattern library
- Manual editing

### 5. Session Monitor
- Active session details
- Real-time progress
- Agent logs streaming
- File changes viewer
- Git commits

### 6. Trackers Management
- Configure output trackers
- Sync status
- Mapping configuration
- Test connections

## Core Features Priority

### Phase 1: Foundation (MVP)
1. **File source adapter** - Read specs from local files
2. **Local JSON tracker** - Track progress locally
3. **Cursor agent adapter** - Use our cursor_autonomous_agent.py
4. **Basic UI** - Dashboard, spec view, session monitor
5. **Coding standards generator** - Analyze and generate standards

### Phase 2: Integrations
6. **Linear adapter** - MCP integration
7. **GitHub adapter** - Issues and Projects
8. **Jira adapter** - REST API integration
9. **Notion adapter** - Database integration
10. **Multi-tracker sync** - Update multiple systems

### Phase 3: Advanced
11. **Claude Code agent** - SDK integration
12. **Knowledge enhancement** - AI-powered prompt enhancement
13. **Pattern recognition** - Auto-detect coding patterns
14. **Workflow automation** - Trigger rules and conditions
15. **Team collaboration** - Multiple users, permissions

## Success Criteria

### Functional
- Pull specs from at least 3 different sources
- Successfully delegate to Cursor agent
- Update progress to multiple trackers
- Generate useful coding standards
- Handle multiple concurrent sessions

### UX
- Clean, intuitive dashboard
- Real-time progress updates
- Clear error messaging
- Easy source/tracker configuration
- Responsive design

### Technical
- Reliable agent execution
- Proper error handling
- Efficient syncing
- Clean API design
- Scalable architecture

## Development Approach

1. **Start with Cursor agent** (already built!)
2. **Build orchestration layer** around it
3. **Add input adapters** one by one
4. **Add output adapters** one by one
5. **Enhance knowledge layer** progressively
6. **Polish UI** throughout

## Initial File Structure (Python Backend - matching autonomous-coding pattern!)

```
sherpa/
├── backend/
│   ├── main.py                # FastAPI application
│   ├── database.py            # SQLite setup with aiosqlite
│   ├── models.py              # Pydantic models
│   ├── adapters/
│   │   ├── __init__.py
│   │   ├── base.py            # Base classes (SpecSource, ProgressTracker, CodingAgent)
│   │   ├── sources/
│   │   │   ├── __init__.py
│   │   │   ├── file.py
│   │   │   ├── linear.py
│   │   │   ├── jira.py
│   │   │   ├── github.py
│   │   │   └── notion.py
│   │   ├── agents/
│   │   │   ├── __init__.py
│   │   │   ├── cursor.py      # Wraps cursor_autonomous_agent.py
│   │   │   ├── claude_code.py # Uses claude-code-sdk
│   │   │   └── base.py
│   │   └── trackers/
│   │       ├── __init__.py
│   │       ├── json.py
│   │       ├── linear.py
│   │       ├── jira.py
│   │       ├── github.py
│   │       └── notion.py
│   ├── knowledge/
│   │   ├── __init__.py
│   │   ├── analyzer.py
│   │   ├── standards_generator.py
│   │   └── prompt_enhancer.py
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── sources.py
│   │   ├── specs.py
│   │   ├── sessions.py
│   │   ├── trackers.py
│   │   └── knowledge.py
│   └── utils/
│       ├── __init__.py
│       └── security.py        # Reuse patterns from autonomous-coding
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── Dashboard.jsx
│   │   │   ├── SourcesManager.jsx
│   │   │   ├── SpecsView.jsx
│   │   │   ├── SessionMonitor.jsx
│   │   │   ├── KnowledgeBase.jsx
│   │   │   └── TrackersManager.jsx
│   │   ├── pages/
│   │   ├── hooks/
│   │   └── utils/
│   ├── index.html
│   └── vite.config.js
├── agents/
│   ├── cursor/                # Symlink or copy of cursor-autonomous-coding
│   │   ├── cursor_autonomous_agent.py
│   │   ├── cursor_client_simple.py
│   │   ├── tools/
│   │   ├── security.py
│   │   └── ...
│   └── shared/                # Shared utilities across agents
│       ├── __init__.py
│       └── progress.py
├── requirements.txt           # Python dependencies
├── package.json               # Frontend dependencies
└── README.md

## Python Dependencies (requirements.txt)

```
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
aiosqlite>=0.19.0
pydantic>=2.5.0
python-multipart>=0.0.6
watchdog>=3.0.0
jira>=3.5.0
PyGithub>=2.1.0
notion-client>=2.2.0
gql[all]>=3.4.1
claude-code-sdk>=0.1.0
python-jose[cryptography]>=3.3.0
passlib[bcrypt]>=1.7.4
```

This is a production-quality Python orchestration system matching the autonomous-coding pattern!

