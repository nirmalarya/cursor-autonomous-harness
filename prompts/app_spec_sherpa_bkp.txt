Project Specification: SHERPA - Autonomous Coding Orchestrator
================================================================

## Overview

SHERPA is a meta-orchestration system that coordinates autonomous coding agents across multiple specification sources and progress tracking systems. It acts as an intelligent middleware that:
1. Pulls requirements from various sources (Jira, Linear, GitHub, Notion, files)
2. Enhances them with coding standards and context
3. Delegates to appropriate coding agents (Cursor, Claude Code, GitHub Copilot)
4. Tracks progress back to multiple systems

## Technology Stack

### Backend
- Runtime: Node.js with Express
- Database: SQLite with better-sqlite3
- Queue: BullMQ (Redis-based job queue for async agent runs)
- API: RESTful + WebSocket for real-time updates

### Frontend
- Framework: React with Vite
- Styling: Tailwind CSS (via CDN)
- State: React Context + hooks
- UI: shadcn/ui components
- Real-time: Socket.io client

### Integrations
- Linear: MCP server integration
- Jira: REST API v3
- GitHub: GraphQL API (Issues, Projects)
- Notion: Official Notion SDK
- Cursor Agent: Subprocess execution (what we just built!)
- Claude Code: SDK integration
- File System: Watch and parse local files

## Architecture Layers

### 1. Spec Sources (Input Adapters)

Each source adapter implements a common interface:

```typescript
interface SpecSource {
  id: string;
  type: 'file' | 'linear' | 'jira' | 'github' | 'notion';
  name: string;
  config: SourceConfig;
  
  // Methods
  fetchSpecs(): Promise<Spec[]>;
  sync(): Promise<SyncResult>;
  validate(): Promise<boolean>;
}

interface Spec {
  id: string;
  title: string;
  description: string;
  requirements: string[];
  acceptanceCriteria: string[];
  priority: 'low' | 'medium' | 'high' | 'critical';
  source: string;
  sourceUrl: string;
  metadata: Record<string, any>;
}
```

**Adapters to implement:**

1. **File/Folder Adapter**
   - Watches directories for markdown files
   - Parses specs from markdown format
   - Supports templates (app_spec.txt format)

2. **Linear Adapter (MCP)**
   - Connects via MCP server
   - Fetches issues/projects
   - Syncs bidirectionally

3. **Jira Adapter (API)**
   - REST API v3 integration
   - JQL query support
   - Custom field mapping

4. **GitHub Adapter**
   - GraphQL API for issues
   - Project v2 support
   - Label filtering

5. **Notion Adapter**
   - Database integration
   - Page parsing
   - Property mapping

### 2. Knowledge Layer

**Purpose:** Enhance specs with project-specific context

Components:

1. **Code Snippet Analyzer**
   ```typescript
   interface SnippetAnalyzer {
     analyzeCodebase(path: string): Promise<Snippet[]>;
     extractPatterns(snippets: Snippet[]): Pattern[];
     generateStandards(patterns: Pattern[]): CodingStandards;
   }
   ```

2. **Coding Standards Generator**
   - Analyzes existing codebase
   - Extracts patterns (naming, structure, imports)
   - Generates CODING_STANDARDS.md
   - Updates based on new code

3. **Prompt Enhancer**
   - Takes base spec
   - Adds coding standards
   - Includes relevant snippets
   - Creates context-rich prompt

### 3. Progress Tracking (Output Adapters)

Each tracker implements:

```typescript
interface ProgressTracker {
  id: string;
  type: 'json' | 'linear' | 'jira' | 'github' | 'notion';
  
  // Methods
  updateProgress(taskId: string, progress: Progress): Promise<void>;
  createTask(spec: Spec): Promise<Task>;
  completeTask(taskId: string): Promise<void>;
  sync(): Promise<void>;
}

interface Progress {
  taskId: string;
  status: 'pending' | 'in_progress' | 'blocked' | 'completed';
  percentComplete: number;
  featuresCompleted: number;
  featuresnTotal: number;
  lastUpdate: Date;
  agentLogs: string[];
  commits: GitCommit[];
}
```

**Trackers to implement:**

1. **Local JSON Tracker**
   - feature_list.json format
   - Git-friendly
   - Fast local access

2. **Linear Tracker**
   - Update issue status
   - Add comments with progress
   - Link commits

3. **Jira Tracker**
   - Transition tickets
   - Update custom fields
   - Add work logs

4. **GitHub Tracker**
   - Update issue status
   - Add progress comments
   - Link PRs/commits

5. **Notion Tracker**
   - Update database properties
   - Add progress blocks
   - Link to code

### 4. Agent Adapters

Each agent implements:

```typescript
interface CodingAgent {
  id: string;
  type: 'cursor' | 'claude-code' | 'github-copilot';
  
  // Methods
  startSession(spec: EnhancedSpec): Promise<Session>;
  monitorProgress(sessionId: string): AsyncIterator<Progress>;
  stopSession(sessionId: string): Promise<void>;
  getStatus(sessionId: string): Promise<SessionStatus>;
}
```

**Agents to implement:**

1. **Cursor Agent** (✅ Already built!)
   - Uses cursor_autonomous_agent.py
   - Subprocess execution
   - Progress monitoring via file system

2. **Claude Code Agent**
   - Uses Claude Code SDK
   - OAuth authentication
   - Real-time streaming

3. **GitHub Copilot Agent** (Future)
   - Copilot Workspace integration
   - API when available

## Database Schema

```sql
-- Sources (input adapters)
CREATE TABLE sources (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  name TEXT NOT NULL,
  config JSON NOT NULL,
  enabled BOOLEAN DEFAULT true,
  last_sync DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Specs (pulled from sources)
CREATE TABLE specs (
  id TEXT PRIMARY KEY,
  source_id TEXT REFERENCES sources(id),
  title TEXT NOT NULL,
  description TEXT,
  requirements JSON,
  acceptance_criteria JSON,
  priority TEXT,
  source_url TEXT,
  metadata JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Coding standards
CREATE TABLE coding_standards (
  id TEXT PRIMARY KEY,
  project_id TEXT,
  content TEXT NOT NULL,
  patterns JSON,
  snippets JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Agent sessions
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  spec_id TEXT REFERENCES specs(id),
  agent_type TEXT NOT NULL,
  status TEXT NOT NULL,
  project_dir TEXT NOT NULL,
  started_at DATETIME,
  completed_at DATETIME,
  error TEXT,
  metadata JSON
);

-- Progress tracking
CREATE TABLE progress (
  id TEXT PRIMARY KEY,
  session_id TEXT REFERENCES sessions(id),
  status TEXT NOT NULL,
  percent_complete INTEGER,
  features_completed INTEGER,
  features_total INTEGER,
  logs JSON,
  commits JSON,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Progress trackers (output adapters)
CREATE TABLE trackers (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,
  name TEXT NOT NULL,
  config JSON NOT NULL,
  enabled BOOLEAN DEFAULT true,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Tracker sync log
CREATE TABLE tracker_syncs (
  id TEXT PRIMARY KEY,
  tracker_id TEXT REFERENCES trackers(id),
  session_id TEXT REFERENCES sessions(id),
  status TEXT NOT NULL,
  synced_at DATETIME,
  error TEXT
);
```

## API Endpoints

### Sources
- `GET /api/sources` - List all spec sources
- `POST /api/sources` - Add new source
- `PUT /api/sources/:id` - Update source
- `DELETE /api/sources/:id` - Remove source
- `POST /api/sources/:id/sync` - Trigger sync
- `GET /api/sources/:id/specs` - Get specs from source

### Specs
- `GET /api/specs` - List all specs
- `GET /api/specs/:id` - Get spec details
- `POST /api/specs` - Create spec manually
- `PUT /api/specs/:id` - Update spec
- `DELETE /api/specs/:id` - Delete spec

### Knowledge
- `POST /api/knowledge/analyze` - Analyze codebase
- `GET /api/knowledge/standards/:projectId` - Get coding standards
- `POST /api/knowledge/enhance` - Enhance spec with standards
- `PUT /api/knowledge/standards/:id` - Update standards

### Sessions
- `POST /api/sessions` - Start new agent session
- `GET /api/sessions` - List sessions
- `GET /api/sessions/:id` - Get session details
- `DELETE /api/sessions/:id` - Stop session
- `GET /api/sessions/:id/progress` - Get real-time progress (SSE)
- `GET /api/sessions/:id/logs` - Get agent logs

### Trackers
- `GET /api/trackers` - List progress trackers
- `POST /api/trackers` - Add tracker
- `PUT /api/trackers/:id` - Update tracker
- `DELETE /api/trackers/:id` - Remove tracker
- `POST /api/trackers/:id/sync` - Manual sync

### Agents
- `GET /api/agents` - List available agents
- `GET /api/agents/:type/status` - Check agent availability

## UI Components

### 1. Dashboard
- Active sessions overview
- Progress summary
- Recent activity
- Quick actions

### 2. Sources Management
- List configured sources
- Add/edit/remove sources
- Sync status
- Connection testing

### 3. Specs View
- List all specs from all sources
- Filter by source/priority/status
- Search and sort
- Spec details modal

### 4. Knowledge Base
- View coding standards
- Codebase snippets
- Pattern library
- Manual editing

### 5. Session Monitor
- Active session details
- Real-time progress
- Agent logs streaming
- File changes viewer
- Git commits

### 6. Trackers Management
- Configure output trackers
- Sync status
- Mapping configuration
- Test connections

## Core Features Priority

### Phase 1: Foundation (MVP)
1. **File source adapter** - Read specs from local files
2. **Local JSON tracker** - Track progress locally
3. **Cursor agent adapter** - Use our cursor_autonomous_agent.py
4. **Basic UI** - Dashboard, spec view, session monitor
5. **Coding standards generator** - Analyze and generate standards

### Phase 2: Integrations
6. **Linear adapter** - MCP integration
7. **GitHub adapter** - Issues and Projects
8. **Jira adapter** - REST API integration
9. **Notion adapter** - Database integration
10. **Multi-tracker sync** - Update multiple systems

### Phase 3: Advanced
11. **Claude Code agent** - SDK integration
12. **Knowledge enhancement** - AI-powered prompt enhancement
13. **Pattern recognition** - Auto-detect coding patterns
14. **Workflow automation** - Trigger rules and conditions
15. **Team collaboration** - Multiple users, permissions

## Success Criteria

### Functional
- Pull specs from at least 3 different sources
- Successfully delegate to Cursor agent
- Update progress to multiple trackers
- Generate useful coding standards
- Handle multiple concurrent sessions

### UX
- Clean, intuitive dashboard
- Real-time progress updates
- Clear error messaging
- Easy source/tracker configuration
- Responsive design

### Technical
- Reliable agent execution
- Proper error handling
- Efficient syncing
- Clean API design
- Scalable architecture

## Development Approach

1. **Start with Cursor agent** (already built!)
2. **Build orchestration layer** around it
3. **Add input adapters** one by one
4. **Add output adapters** one by one
5. **Enhance knowledge layer** progressively
6. **Polish UI** throughout

## Initial File Structure

```
sherpa/
├── backend/
│   ├── server.js              # Express server
│   ├── database.js            # SQLite setup
│   ├── adapters/
│   │   ├── sources/
│   │   │   ├── file.js
│   │   │   ├── linear.js
│   │   │   ├── jira.js
│   │   │   ├── github.js
│   │   │   └── notion.js
│   │   ├── agents/
│   │   │   ├── cursor.js      # Wraps our cursor_autonomous_agent.py
│   │   │   ├── claude-code.js
│   │   │   └── base.js
│   │   └── trackers/
│   │       ├── json.js
│   │       ├── linear.js
│   │       ├── jira.js
│   │       ├── github.js
│   │       └── notion.js
│   ├── knowledge/
│   │   ├── analyzer.js
│   │   ├── standards-generator.js
│   │   └── prompt-enhancer.js
│   └── routes/
│       ├── sources.js
│       ├── specs.js
│       ├── sessions.js
│       ├── trackers.js
│       └── knowledge.js
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── Dashboard.jsx
│   │   │   ├── SourcesManager.jsx
│   │   │   ├── SpecsView.jsx
│   │   │   ├── SessionMonitor.jsx
│   │   │   ├── KnowledgeBase.jsx
│   │   │   └── TrackersManager.jsx
│   │   ├── pages/
│   │   ├── hooks/
│   │   └── utils/
│   └── index.html
├── agents/
│   └── cursor/                # Our cursor-autonomous-coding
│       ├── cursor_autonomous_agent.py
│       ├── monitor_progress.sh
│       └── ...
└── package.json
```

This is a production-quality orchestration system for autonomous coding at scale!

